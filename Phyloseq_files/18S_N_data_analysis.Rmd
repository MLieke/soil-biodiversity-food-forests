---
title: "18S_N_data_analysis"
output: html_document
date: "2024-04-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(phyloseq)
library(MicEco)
library(metagenomeSeq)
library(metagMisc)
library(vegan)
library(iNEXT)
library(ggforce)
library(data.table)
library(indicspecies)
library(plotly)
```

```{r data}
ps <- readRDS("ps_18S_N_NemaTaxa.rds")
```

```{r check phyla}
ps %>% rank_names()
colnames(tax_table(ps)) <- c("Phylum", "Class", "Order", "Family", "Genus")
ps %>% get_taxa_unique("Phylum")
# rowSums(otu_table(ps))

ps_N <- ps %>% subset_taxa(Phylum == "P:Nematoda")
# ps_N
# sample_sums(ps_N)
# sort(sample_sums(ps_N))
ps_N_2 <- subset_samples(ps_N, sample_sums(ps_N) > 10000)
# rownames(otu_table(ps_N))[rowSums(otu_table(ps_N)) < 10000]
# sort(sample_sums(ps_N_2))
min(taxa_sums(ps_N_2))
ps_N_3 <- prune_taxa(taxa_sums(ps_N_2) > 0, ps_N_2)
saveRDS(ps_N_3, "ps_nematodes.RDS")
```

```{r}
recoding <- read.csv2("dna_code_18S_N_site.csv")
recoding$i5_code <- recoding$dna_code#paste0("i5.",recoding$dna_code)
ASV <- as(otu_table(ps_N_3), "matrix")
# transpose if necessary
if(taxa_are_rows(ps_N_3)){ASV <- t(ASV)}
# Coerce to data.frame
ASVdf = as.data.frame(ASV)
ASV_string <- paste0("ASV", seq(ntaxa(ps_N_3)))
colnames(ASVdf) <- ASV_string
ASVdf$i5_code <- rownames(ASVdf)
ASVdf <- ASVdf %>% left_join(recoding[,c("i5_code", "code")], by="i5_code")
rownames(ASVdf) <- ASVdf$code
ASVdf <- ASVdf %>% select(-c(i5_code, code))
# write.csv(ASVdf, "18S_N_P2.csv")
N18S_dist <- avgdist(ASVdf, sample=min(sample_sums(ps_N_3)), iterations=50)
saveRDS(N18S_dist, "N18S_dist.rds")
```

```{r depth cutoff}
#check read depth
read_abund <- data.frame(abund = rowSums(otu_table(ps_N)))
read_abund$i5_code <- rownames(read_abund)
read_abund <- read_abund %>% separate(i5_code, c("i5","dna_code"))
read_abund <- read_abund %>% left_join(recoding[,c("dna_code", "code","landuse")], by="dna_code")
read_abund %>% ggplot(aes(x=1, y=abund, label=code)) +
  scale_y_log10() +
  geom_jitter(position = position_jitter(seed = 1)) + ggrepel::geom_text_repel(position = position_jitter(seed = 1))

# 10000 seems a reasonable cutoff, only loose 3 samples VB051 GL, VB021 AF, VB056 FF

read_abund %>% arrange(abund) %>% 
  ggplot(aes(x=1:nrow(.),y=abund)) + geom_line()

read_abund %>% arrange(abund) %>% print(n=30)
```

```{r check library size}
# Extract sample-wise read counts
sample_reads <- sample_sums(otu_table(ps_N))
hist(sample_reads, breaks=100)

# Extract sample-wise counts of ASVs
sample_asvs <- sample_sums(otu_table(ps_N) > 0)

plot(sample_reads, sample_asvs,
     xlab = "Number of Reads",
     ylab = "Number of ASVs",
     main = "Number of Reads vs Number of ASVs per Sample")

# Add regression line
abline(lm(sample_asvs ~ sample_reads))

# Calculate R-squared and p-value
fit<-lm(sample_asvs~sample_reads)
rsquared <- summary(fit)$r.squared
p_value <- summary(fit)$coefficients[2, 4]

# Add R-squared and p-value to the plot
text(x = max(sample_reads) * 0.7, y = max(sample_asvs) * 0.8,
     labels = paste("RÂ² =", round(rsquared, 2), "\np =", signif(p_value, digits = 3)),
     adj = c(-1, 0))
```

``` {r iNEXT}
site_info <- read_csv2("dna_code_18S_N_site.csv")
min(sample_sums(ps_N_3))

#estimateD on plot based data
iNEXT_input_table <- otu_table(ps_N_3) %>%
  t() %>%
  data.frame()
set.seed(183494)
Hill_plot_1 <- estimateD(iNEXT_input_table, q = 1,
                           datatype = "abundance",
                          base = "size", min(sample_sums(ps_N_3)))
Hill_plot_1$dna_code <- Hill_plot_1$Assemblage
Hill_plot_1 <- left_join(Hill_plot_1, site_info[,c("dna_code","code","unique_site","landuse", "location", "texture")], by= "dna_code")
write.csv(Hill_plot_1, file="Hill_1_18S_N.csv")
# inext_out <- iNEXT(iNEXT_input_table_16S, q = 1, datatype = "abundance")

# q=0 for supplement
Hill_plot_0 <- estimateD(iNEXT_input_table, q=0,
                         datatype="abundance",
                         base="size", min(sample_sums(ps_N_3)))
Hill_plot_0$dna_code <- Hill_plot_0$Assemblage
Hill_plot_0 <- left_join(Hill_plot_0, site_info[,c("dna_code","code","unique_site","landuse", "location", "texture")], by= "dna_code")
write.csv(Hill_plot_0, file="Hill_0_18S_N.csv")

# q=2 for supplement
Hill_plot_2 <- estimateD(iNEXT_input_table, q=2,
                         datatype="abundance",
                         base="size", min(sample_sums(ps_N_3)))
Hill_plot_2 <- Hill_plot_2 %>% separate(Assemblage, c("i5", "dna_code"))
Hill_plot_2 <- left_join(Hill_plot_2, site_info[,c("dna_code","unique_site","landuse", "location", "texture")], by= "dna_code")
write.csv(Hill_plot_2, file="Hill_2_18S_N.csv")
```

```{r rarefaction}
vb_colors <- c( "#F0E442","#56B4E9","#D55E00", "#009E73")

r <- ggrare(ps_N_3, step = 100, color = "landuse", se=FALSE)
r <- r + scale_color_manual(values=vb_colors) +
  xlim(c(0,50000)) +
  geom_vline(xintercept=10057) + xlab("Sample read depth")

saveRDS(r, "rarefaction_nematodes.RDS")
```
